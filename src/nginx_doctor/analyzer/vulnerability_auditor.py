"""Vulnerability Auditor - Evaluates package CVE/advisory posture."""

from nginx_doctor.model.evidence import Evidence, Severity
from nginx_doctor.model.finding import Finding
from nginx_doctor.model.server import ServerModel


class VulnerabilityAuditor:
    """Auditor for package vulnerability posture."""

    def __init__(self, model: ServerModel) -> None:
        self.model = model

    def audit(self) -> list[Finding]:
        findings: list[Finding] = []
        if not hasattr(self.model, "vulnerability"):
            return findings

        findings.extend(self._check_cve_count())
        findings.extend(self._check_advisories())
        findings.extend(self._check_large_affected_surface())
        return findings

    def _check_cve_count(self) -> list[Finding]:
        cve_count = len(self.model.vulnerability.cve_ids)
        if cve_count == 0:
            return []

        severity = Severity.CRITICAL if cve_count >= 20 else Severity.WARNING
        sample = ", ".join(self.model.vulnerability.cve_ids[:5])
        return [
            Finding(
                id="VULN-1",
                severity=severity,
                confidence=0.85,
                condition=f"{cve_count} CVE reference(s) detected in package security metadata",
                cause=(
                    f"{self.model.vulnerability.provider} security tooling reported CVE references "
                    "for pending package security items."
                ),
                evidence=[
                    Evidence(
                        source_file="package-security",
                        line_number=1,
                        excerpt=sample,
                        command="package manager security status",
                    )
                ],
                treatment="Prioritize security patching and verify service restarts/reboot requirements.",
                impact=[
                    "Known vulnerabilities may remain exploitable",
                    "Higher breach and compliance risk",
                ],
            )
        ]

    def _check_advisories(self) -> list[Finding]:
        if self.model.vulnerability.cve_ids:
            return []

        advisory_count = len(self.model.vulnerability.advisory_ids)
        if advisory_count == 0:
            return []

        severity = Severity.WARNING if advisory_count >= 10 else Severity.INFO
        sample = ", ".join(self.model.vulnerability.advisory_ids[:5])
        return [
            Finding(
                id="VULN-2",
                severity=severity,
                confidence=0.75,
                condition=f"{advisory_count} security advisory reference(s) detected",
                cause=(
                    f"{self.model.vulnerability.provider} security metadata reports pending advisories, "
                    "but explicit CVE mapping was not available."
                ),
                evidence=[
                    Evidence(
                        source_file="package-security",
                        line_number=1,
                        excerpt=sample,
                        command="package manager advisory listing",
                    )
                ],
                treatment="Apply security advisories and refresh vulnerability metadata.",
                impact=[
                    "Potential unpatched security issues may remain",
                ],
            )
        ]

    def _check_large_affected_surface(self) -> list[Finding]:
        pkg_count = len(self.model.vulnerability.affected_packages)
        if pkg_count < 50:
            return []

        return [
            Finding(
                id="VULN-3",
                severity=Severity.INFO,
                confidence=0.70,
                condition=f"Large package security update surface detected ({pkg_count} packages)",
                cause="A high number of packages appear in pending security/update posture output.",
                evidence=[
                    Evidence(
                        source_file="package-security",
                        line_number=1,
                        excerpt=", ".join(self.model.vulnerability.affected_packages[:5]),
                        command="package manager upgradable/security listing",
                    )
                ],
                treatment="Use phased updates and maintenance windows to reduce patch backlog.",
                impact=[
                    "Operational risk increases with larger unpatched surface",
                ],
            )
        ]
