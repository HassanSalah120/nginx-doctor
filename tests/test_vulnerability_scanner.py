"""Tests for VulnerabilityScanner parsing behavior."""

from unittest.mock import MagicMock

from nginx_doctor.scanner.vulnerability import VulnerabilityScanner


def test_scan_apt_with_cve_from_json(mock_ssh_connector):
    scanner = VulnerabilityScanner(mock_ssh_connector)

    apt_output = """Listing...
openssl/jammy-security 3.0 amd64 [upgradable from: 2.9]
curl/jammy-updates 7.68 amd64 [upgradable from: 7.67]
"""
    pro_json = '{"issues":[{"id":"CVE-2025-12345"},{"id":"USN-7000-1"}]}'

    def run_side_effect(cmd, **kwargs):
        if "which apt" in cmd:
            return MagicMock(success=True, stdout="/usr/bin/apt\n")
        if "apt list --upgradable" in cmd:
            return MagicMock(success=True, stdout=apt_output)
        if "pro security-status --format json" in cmd:
            return MagicMock(success=True, stdout=pro_json)
        if "ubuntu-security-status --format json" in cmd:
            return MagicMock(success=False, stdout="")
        return MagicMock(success=False, stdout="")

    mock_ssh_connector.run.side_effect = run_side_effect

    result = scanner.scan()
    assert result.provider == "apt"
    assert "OPENSSL" not in result.affected_packages  # ensure package case untouched
    assert "openssl" in result.affected_packages
    assert "CVE-2025-12345" in result.cve_ids
    assert "USN-7000-1" in result.advisory_ids


def test_scan_dnf_extracts_advisories_and_cves(mock_ssh_connector):
    scanner = VulnerabilityScanner(mock_ssh_connector)

    list_out = "RHSA-2025:1111 Important/Sec. openssl-3.0.0-1.el9.x86_64\n"
    info_out = "CVE-2024-99999 affects openssl\n"

    def run_side_effect(cmd, **kwargs):
        if "which apt" in cmd:
            return MagicMock(success=False, stdout="")
        if "which dnf" in cmd:
            return MagicMock(success=True, stdout="/usr/bin/dnf\n")
        if "updateinfo list" in cmd:
            return MagicMock(success=True, stdout=list_out)
        if "updateinfo info" in cmd:
            return MagicMock(success=True, stdout=info_out)
        return MagicMock(success=False, stdout="")

    mock_ssh_connector.run.side_effect = run_side_effect

    result = scanner.scan()
    assert result.provider == "dnf"
    assert "RHSA-2025:1111" in result.advisory_ids
    assert "CVE-2024-99999" in result.cve_ids
